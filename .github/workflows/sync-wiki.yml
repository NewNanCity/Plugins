name: åŒæ­¥æ–‡æ¡£åˆ° Wiki

on:
  push:
    branches: [main, master]
    paths:
      - "docs/**"
  workflow_dispatch:

jobs:
  sync-wiki:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: å‡†å¤‡ Wiki æ–‡æ¡£
        run: |
          python scripts/prepare-wiki-multi.py

      - name: æ£€å‡º Wiki åˆ†æ”¯
        run: |
          # æ£€æŸ¥ wiki åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --heads origin wiki | grep -q wiki; then
            echo "Wiki åˆ†æ”¯å·²å­˜åœ¨ï¼Œåˆ‡æ¢åˆ° wiki åˆ†æ”¯"
            git fetch origin wiki
            git checkout wiki
          else
            echo "åˆ›å»ºæ–°çš„ wiki åˆ†æ”¯"
            git checkout --orphan wiki
            git rm -rf .
          fi

      - name: å¤åˆ¶ Wiki æ–‡æ¡£
        run: |
          # æ¸…ç©ºå½“å‰ç›®å½•ï¼ˆä¿ç•™ .gitï¼‰
          find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +

          # å¤åˆ¶ wiki æ–‡æ¡£
          cp -r wiki/* .

          # _Sidebar.md å·²ç”±è„šæœ¬ç”Ÿæˆï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»º

          # åˆ›å»º _Footer.md æ–‡ä»¶
          cat > _Footer.md << 'EOF'
          ---
          ðŸ“ **æ–‡æ¡£ç‰ˆæœ¬**: $(date '+%Y-%m-%d %H:%M:%S')
          ðŸ”„ **è‡ªåŠ¨åŒæ­¥**: æ­¤æ–‡æ¡£ç”± GitHub Actions è‡ªåŠ¨åŒæ­¥
          ðŸ“– **æºç **: [æŸ¥çœ‹æºç ](https://github.com/${{ github.repository }})
          EOF

      - name: é…ç½® Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: æäº¤æ›´æ”¹
        run: |
          git add .

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡æ¡£æ›´æ”¹"
            exit 0
          fi

          # èŽ·å–æœ€æ–°æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=format:"%s" origin/${{ github.ref_name }})

          git commit -m "ðŸ“š åŒæ­¥æ–‡æ¡£æ›´æ–°: $COMMIT_MSG" \
                     -m "è‡ªåŠ¨åŒæ­¥æ¥è‡ª ${{ github.ref_name }} åˆ†æ”¯çš„æ–‡æ¡£æ›´æ”¹" \
                     -m "æäº¤å“ˆå¸Œ: ${{ github.sha }}"

      - name: æŽ¨é€åˆ° Wiki åˆ†æ”¯
        run: |
          git push origin wiki
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è¾“å‡ºåŒæ­¥ç»“æžœ
        run: |
          echo "âœ… Wiki æ–‡æ¡£åŒæ­¥å®Œæˆ!"
          echo "ðŸ“ åŒæ­¥çš„æ–‡ä»¶:"
          ls -la *.md
          echo ""
          echo "ðŸ”— è®¿é—® Wiki: https://github.com/${{ github.repository }}/wiki"
