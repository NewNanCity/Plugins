# Database æ¨¡å—ç”¨æˆ·æ•™ç¨‹

æ¬¢è¿ä½¿ç”¨ç°ä»£åŒ–çš„æ•°æ®åº“ç®¡ç†æ¡†æ¶ï¼æœ¬æ•™ç¨‹å°†å¸¦æ‚¨ä»é›¶å¼€å§‹å­¦ä¹ å¦‚ä½•ä½¿ç”¨ Database æ¨¡å—æ„å»ºå¼ºå¤§çš„æ•°æ®åº“åº”ç”¨ã€‚

## ğŸ“š æ–‡æ¡£ç›®å½•

### åŸºç¡€æ•™ç¨‹
- [ğŸ“– ä»‹ç»](intro.md) - 5åˆ†é’Ÿå¿«é€Ÿäº†è§£Databaseæ¨¡å—
- [ğŸš€ å¿«é€Ÿå¼€å§‹](quick-start.md) - ç¬¬ä¸€ä¸ªæ•°æ®åº“è¿æ¥
- [ğŸ¯ åŸºç¡€æ¦‚å¿µ](concepts.md) - æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

### åŠŸèƒ½æŒ‡å—
- [ğŸ”— è¿æ¥æ± ç®¡ç†](connection-pool.md) - HikariCPè¿æ¥æ± é…ç½®
- [ğŸ—„ï¸ å¤šæ•°æ®åº“æ”¯æŒ](databases.md) - MySQLã€PostgreSQLã€SQLiteã€H2
- [ğŸ› ï¸ DSLé…ç½®](dsl.md) - æµç•…çš„é…ç½®API
- [ğŸ’¼ äº‹åŠ¡ç®¡ç†](transactions.md) - äº‹åŠ¡æ”¯æŒå’Œè‡ªåŠ¨å›æ»š
- [âš¡ æ‰¹é‡æ“ä½œ](batch-operations.md) - é«˜æ€§èƒ½æ‰¹é‡SQLæ‰§è¡Œ
- [ğŸ“Š ç›‘æ§ç»Ÿè®¡](monitoring.md) - è¿æ¥æ± ç›‘æ§å’Œå¥åº·æ£€æŸ¥

### é«˜çº§ä¸»é¢˜
- [ğŸ”§ æ€§èƒ½ä¼˜åŒ–](performance.md) - MySQLä¼˜åŒ–é…ç½®å’Œæœ€ä½³å®è·µ
- [ğŸ”„ ç”Ÿå‘½å‘¨æœŸç®¡ç†](lifecycle.md) - èµ„æºç®¡ç†å’Œè‡ªåŠ¨æ¸…ç†
- [ğŸ—ï¸ æ¶æ„è®¾è®¡](architecture.md) - æ¨¡å—æ¶æ„å’Œè®¾è®¡æ¨¡å¼
- [âš™ï¸ è‡ªå®šä¹‰æ‰©å±•](extensions.md) - è‡ªå®šä¹‰æ•°æ®åº“æ”¯æŒ

### å‚è€ƒèµ„æ–™
- [ğŸ“‹ APIå‚è€ƒ](api-reference.md) - å®Œæ•´APIæ–‡æ¡£
- [ğŸ’¡ æœ€ä½³å®è·µ](best-practices.md) - å¼€å‘å»ºè®®å’Œæ¨¡å¼
- [ğŸ”§ æ•…éšœæ’é™¤](troubleshooting.md) - å¸¸è§é—®é¢˜è§£å†³
- [ğŸ“ ç¤ºä¾‹ä»£ç ](examples.md) - å®Œæ•´ç¤ºä¾‹é›†åˆ

## ğŸ¯ å¿«é€Ÿå¯¼èˆª

### æˆ‘æƒ³è¦...
- **è¿æ¥ç¬¬ä¸€ä¸ªæ•°æ®åº“** â†’ [å¿«é€Ÿå¼€å§‹](quick-start.md)
- **é…ç½®è¿æ¥æ± ** â†’ [è¿æ¥æ± ç®¡ç†](connection-pool.md)
- **ä½¿ç”¨ä¸åŒæ•°æ®åº“** â†’ [å¤šæ•°æ®åº“æ”¯æŒ](databases.md)
- **ä½¿ç”¨DSLè¯­æ³•** â†’ [DSLé…ç½®](dsl.md)
- **ç®¡ç†äº‹åŠ¡** â†’ [äº‹åŠ¡ç®¡ç†](transactions.md)
- **æ‰¹é‡æ“ä½œ** â†’ [æ‰¹é‡æ“ä½œ](batch-operations.md)
- **ç›‘æ§æ•°æ®åº“** â†’ [ç›‘æ§ç»Ÿè®¡](monitoring.md)
- **ä¼˜åŒ–æ€§èƒ½** â†’ [æ€§èƒ½ä¼˜åŒ–](performance.md)
- **è§£å†³é—®é¢˜** â†’ [æ•…éšœæ’é™¤](troubleshooting.md)

## ğŸ†• æœ€æ–°ç‰¹æ€§

- **HikariCPè¿æ¥æ± ** - é«˜æ€§èƒ½è¿æ¥æ± ç®¡ç†ï¼Œèåˆviolet/sqlä¼˜åŒ–é…ç½®
- **å¤šæ•°æ®åº“æ”¯æŒ** - MySQLã€PostgreSQLã€SQLiteã€H2å…¨é¢æ”¯æŒ
- **DSLé…ç½®API** - æµç•…çš„Kotlin DSLé£æ ¼é…ç½®ï¼Œæ”¯æŒinfixå‡½æ•°
- **äº‹åŠ¡ç®¡ç†** - å†…ç½®äº‹åŠ¡æ”¯æŒï¼Œå¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»š
- **æ‰¹é‡æ“ä½œ** - æ”¯æŒæ‰¹é‡SQLæ‰§è¡Œï¼Œå¤§å¹…æå‡æ€§èƒ½
- **è¿æ¥æ± ç›‘æ§** - å®æ—¶ç›‘æ§è¿æ¥æ± çŠ¶æ€å’Œå¥åº·æ£€æŸ¥
- **MySQLä¼˜åŒ–** - å†…ç½®HikariCPå®˜æ–¹æ¨èçš„MySQLæ€§èƒ½ä¼˜åŒ–é…ç½®
- **èµ„æºç®¡ç†** - å®ç°Terminableæ¥å£ï¼Œè‡ªåŠ¨æ¸…ç†èµ„æº

## ğŸ”§ æ”¯æŒçš„æ•°æ®åº“

### ç”Ÿäº§çº§æ•°æ®åº“
- **MySQL** - æœ€æµè¡Œçš„å¼€æºå…³ç³»å‹æ•°æ®åº“
- **PostgreSQL** - åŠŸèƒ½å¼ºå¤§çš„å¼€æºå¯¹è±¡å…³ç³»å‹æ•°æ®åº“

### è½»é‡çº§æ•°æ®åº“
- **SQLite** - åµŒå…¥å¼æ•°æ®åº“ï¼Œé€‚åˆå°å‹åº”ç”¨
- **H2** - å†…å­˜/æ–‡ä»¶æ•°æ®åº“ï¼Œé€‚åˆæµ‹è¯•å’Œå¼€å‘

### ä¾èµ–é…ç½®
```kotlin
dependencies {
    // Database æ¨¡å—ï¼ˆå·²åŒ…å« HikariCPï¼‰
    implementation(project(":modules:database"))

    // æ ¹æ®éœ€è¦æ·»åŠ å…·ä½“çš„æ•°æ®åº“é©±åŠ¨
    implementation("mysql:mysql-connector-java:8.0.33")      // MySQL
    implementation("org.postgresql:postgresql:42.7.1")       // PostgreSQL
    implementation("org.xerial:sqlite-jdbc:3.44.1.0")        // SQLite
    implementation("com.h2database:h2:2.2.224")              // H2

    // å¦‚æœä½¿ç”¨ ORMï¼ˆæ¨èï¼‰
    implementation("org.ktorm:ktorm-core:3.6.0")             // Ktorm æ ¸å¿ƒ
    implementation("org.ktorm:ktorm-support-mysql:3.6.0")    // MySQL æ–¹è¨€æ”¯æŒ
    implementation("org.ktorm:ktorm-support-postgresql:3.6.0") // PostgreSQL æ–¹è¨€æ”¯æŒ
}
```

## ğŸš€ å¿«é€Ÿé¢„è§ˆ

### Kotlin DSLé£æ ¼ï¼ˆæ¨èï¼‰
```kotlin
class MyPlugin : BasePlugin() {
    override fun onPluginEnable() {
        // MySQLæ•°æ®åº“é…ç½®
        val db = mysql {
            host = "localhost"
            port = 3306
            database = "myserver"
            username = "minecraft"
            password = "secret123"

            // è¿æ¥æ± é…ç½®
            pool {
                maximumPoolSize = 10
                minimumIdle = 2
                connectionTimeout = 30000
                idleTimeout = 600000
            }

            // MySQLä¼˜åŒ–é…ç½®
            properties {
                "useSSL" to "false"
                "useUnicode" to "true"
                "characterEncoding" to "utf8mb4"
                "serverTimezone" to "Asia/Shanghai"
            }
        }

        // ä½¿ç”¨æ•°æ®åº“
        tasks {
            runAsync {
                db.useConnection { connection ->
                    val statement = connection.prepareStatement(
                        "SELECT * FROM players WHERE uuid = ?"
                    )
                    statement.setString(1, player.uniqueId.toString())
                    val result = statement.executeQuery()

                    while (result.next()) {
                        val playerName = result.getString("name")
                        logger.info("æ‰¾åˆ°ç©å®¶: $playerName")
                    }
                }
            }
        }
    }
}
```

### Javaå…¼å®¹å·¥å‚å‡½æ•°
```kotlin
class JavaCompatiblePlugin : BasePlugin() {
    override fun onPluginEnable() {
        // ä½¿ç”¨å·¥å‚å‡½æ•°åˆ›å»ºæ•°æ®åº“ç®¡ç†å™¨
        val config = MySQLConfig(
            host = "localhost",
            port = 3306,
            database = "myserver",
            username = "minecraft",
            password = "secret123"
        )

        val databaseManager = DatabaseManager(this)
        databaseManager.initialize(config)
        bind(databaseManager)

        // ä½¿ç”¨æ•°æ®åº“
        runAsync {
            databaseManager.useConnection { connection ->
                // æ•°æ®åº“æ“ä½œ
            }
        }
    }
}
```

### æ•°æ®åº“æ“ä½œæ–¹å¼

Database æ¨¡å—æ”¯æŒä¸¤ç§æ•°æ®åº“æ“ä½œæ–¹å¼ï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®éœ€æ±‚é€‰æ‹©ï¼š

#### æ–¹å¼ä¸€ï¼šORM æ“ä½œï¼ˆæ¨èï¼‰
ä½¿ç”¨ Ktorm ç­‰ç°ä»£ ORM åº“ï¼Œä»£ç æ›´ç®€æ´ã€ç±»å‹å®‰å…¨ï¼š

```kotlin
// å®šä¹‰è¡¨ç»“æ„
object Players : Table<Nothing>("players") {
    val uuid = varchar("uuid").primaryKey()
    val name = varchar("name")
    val level = int("level")
}

override fun onPluginEnable() {
    val db = mysql { /* é…ç½® */ }

    // åˆ›å»º Ktorm Database å®ä¾‹
    val database = Database.connect(
        dataSource = db.hikariDataSource!!,
        dialect = MySqlDialect()
    )

    tasks {
        runAsync {
            // ä½¿ç”¨ Ktorm ORM æ“ä½œ
            database.insert(Players) {
                set(it.uuid, player.uniqueId.toString())
                set(it.name, player.name)
                set(it.level, 1)
            }

            // æŸ¥è¯¢æ“ä½œ
            val playerData = database.from(Players)
                .select()
                .where { Players.uuid eq player.uniqueId.toString() }
                .map { row ->
                    PlayerData(
                        uuid = UUID.fromString(row[Players.uuid]!!),
                        name = row[Players.name]!!,
                        level = row[Players.level]!!
                    )
                }
                .firstOrNull()
        }
    }
}
```

#### æ–¹å¼äºŒï¼šåŸç”Ÿ SQL æ“ä½œ
ä½¿ç”¨åŸç”Ÿ SQLï¼Œæä¾›æœ€å¤§çš„çµæ´»æ€§å’Œæ§åˆ¶ï¼š

```kotlin
override fun onPluginEnable() {
    val db = mysql { /* é…ç½® */ }

    tasks {
        runAsync {
            // è‡ªåŠ¨äº‹åŠ¡ç®¡ç†
            db.useTransaction { connection ->
                // æ’å…¥ç©å®¶æ•°æ®
                val insertPlayer = connection.prepareStatement(
                    "INSERT INTO players (uuid, name, level) VALUES (?, ?, ?)"
                )
                insertPlayer.setString(1, player.uniqueId.toString())
                insertPlayer.setString(2, player.name)
                insertPlayer.setInt(3, 1)
                insertPlayer.executeUpdate()

                // æ’å…¥ç»Ÿè®¡æ•°æ®
                val insertStats = connection.prepareStatement(
                    "INSERT INTO player_stats (uuid, join_time) VALUES (?, ?)"
                )
                insertStats.setString(1, player.uniqueId.toString())
                insertStats.setTimestamp(2, Timestamp(System.currentTimeMillis()))
                insertStats.executeUpdate()

                // å¦‚æœä»»ä½•æ“ä½œå¤±è´¥ï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
            }
        }
    }
}
```

#### é€‰æ‹©å»ºè®®

- **æ¨èä½¿ç”¨ ORMï¼ˆKtormï¼‰**ï¼šé€‚åˆå¤§å¤šæ•°å¸¸è§„ CRUD æ“ä½œï¼Œä»£ç æ›´ç®€æ´ã€ç±»å‹å®‰å…¨
- **ä½¿ç”¨åŸç”Ÿ SQL**ï¼šé€‚åˆå¤æ‚æŸ¥è¯¢ã€æ€§èƒ½æ•æ„Ÿåœºæ™¯ã€éœ€è¦ç‰¹å®š SQL åŠŸèƒ½çš„æƒ…å†µ

### æ‰¹é‡æ“ä½œ

#### ORM æ‰¹é‡æ“ä½œï¼ˆæ¨èï¼‰
```kotlin
override fun onPluginEnable() {
    val db = mysql { /* é…ç½® */ }
    val database = Database.connect(db.hikariDataSource!!, MySqlDialect())

    tasks {
        runAsync {
            // Ktorm æ‰¹é‡æ’å…¥
            database.batchInsert(PlayerActions) {
                repeat(1000) { i ->
                    item {
                        set(it.uuid, UUID.randomUUID().toString())
                        set(it.action, "action_$i")
                        set(it.timestamp, Timestamp(System.currentTimeMillis()))
                    }
                }
            }
            logger.info("æ‰¹é‡æ’å…¥äº† 1000 æ¡è®°å½•")
        }
    }
}
```

#### åŸç”Ÿ SQL æ‰¹é‡æ“ä½œ
```kotlin
override fun onPluginEnable() {
    val db = mysql { /* é…ç½® */ }

    tasks {
        runAsync {
            // åŸç”Ÿ SQL æ‰¹é‡æ’å…¥
            db.useBatch { batch ->
                val sql = "INSERT INTO player_actions (uuid, action, timestamp) VALUES (?, ?, ?)"

                // æ·»åŠ å¤šä¸ªæ‰¹é‡æ“ä½œ
                repeat(1000) { i ->
                    batch.addBatch(sql) { statement ->
                        statement.setString(1, UUID.randomUUID().toString())
                        statement.setString(2, "action_$i")
                        statement.setTimestamp(3, Timestamp(System.currentTimeMillis()))
                    }
                }

                // æ‰§è¡Œæ‰¹é‡æ“ä½œ
                val results = batch.executeBatch()
                logger.info("æ‰¹é‡æ’å…¥äº† ${results.sum()} æ¡è®°å½•")
            }
        }
    }
}
```

### è¿æ¥æ± ç›‘æ§
```kotlin
override fun onPluginEnable() {
    val db = mysql { /* é…ç½® */ }

    // å®šæœŸç›‘æ§è¿æ¥æ± çŠ¶æ€
    runSyncRepeating(0L, 20L * 30) { // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        val stats = db.getPoolStats()
        logger.info("""
            è¿æ¥æ± çŠ¶æ€:
            - æ´»è·ƒè¿æ¥: ${stats.activeConnections}
            - ç©ºé—²è¿æ¥: ${stats.idleConnections}
            - æ€»è¿æ¥æ•°: ${stats.totalConnections}
            - ç­‰å¾…è¿æ¥æ•°: ${stats.threadsAwaitingConnection}
        """.trimIndent())

        // å¥åº·æ£€æŸ¥
        if (db.isHealthy()) {
            logger.info("æ•°æ®åº“è¿æ¥æ­£å¸¸")
        } else {
            logger.warning("æ•°æ®åº“è¿æ¥å¼‚å¸¸ï¼")
        }
    }
}
```

## ğŸ¤ è´¡çŒ®

å¦‚æœæ‚¨å‘ç°æ–‡æ¡£ä¸­çš„é”™è¯¯æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œæ¬¢è¿æäº¤Issueæˆ–Pull Requestã€‚

---

**å¼€å§‹æ‚¨çš„Databaseå¼€å‘ä¹‹æ—…** â†’ [ğŸ“– ä»‹ç»](intro.md)
