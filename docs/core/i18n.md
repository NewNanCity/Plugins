# 国际化系统

Core 模块提供了完整的国际化（i18n）支持，包括多语言文件管理、自动语言检测、模板参数替换和生命周期管理。

## 🎯 核心特性

### 多语言支持
- **语言文件管理** - 支持多种语言的 YAML 配置文件
- **自动回退** - 主语言 → 默认语言 → 硬编码文本的回退机制
- **动态切换** - 运行时语言配置重载支持

### 模板系统
- **参数替换** - 使用 `{0}` `{1}` 等 StringFormat 语法
- **模板语法** - 使用 `<%key%>` 格式的模板引用
- **类型安全** - 编译时模板检查和参数验证

### 生命周期集成
- **自动初始化** - 与插件生命周期深度集成
- **配置重载** - 支持语言配置的热重载
- **缓存管理** - 智能缓存提升性能

## 🚀 基础用法

### 设置语言管理器

```kotlin
class MyPlugin : BasePlugin() {
    
    override fun reloadPlugin() {
        try {
            // 清理配置缓存
            configManager.clearCache()
            
            // 设置语言管理器
            setupLanguageManager(
                languageFiles = mapOf(
                    Locale.SIMPLIFIED_CHINESE to "lang/zh_CN.yml",
                    Locale.US to "lang/en_US.yml",
                    Locale.JAPAN to "lang/ja_JP.yml"
                ),
                majorLanguage = Locale.SIMPLIFIED_CHINESE,  // 主要语言
                defaultLanguage = Locale.US                 // 默认回退语言
            )
            
            super.reloadPlugin()
        } catch (e: Exception) {
            logger.error("配置重载失败", e)
            throw e
        }
    }
}
```

### 语言文件结构

#### 中文语言文件 (lang/zh_CN.yml)
```yaml
# 欢迎消息
welcome:
  message: "欢迎 {0} 加入服务器！"
  first_time: "这是你第一次加入服务器"
  returning: "欢迎回来，{0}！你已经离线 {1}"

# 玩家相关
player:
  level_info: "玩家 {0} 当前等级：{1}"
  not_found: "找不到玩家 {0}"
  offline: "玩家 {0} 当前离线"
  balance: "你的余额：{0} 金币"

# 插件消息
plugin:
  enabled: "插件已启用"
  disabled: "插件已禁用"
  config:
    reloaded: "配置重载成功"
    reloading: "正在重载配置..."
    reload_failed: "配置重载失败"

# 错误消息
error:
  no_permission: "你没有权限执行此操作"
  invalid_argument: "无效的参数：{0}"
  command_failed: "命令执行失败：{0}"
  insufficient_funds: "余额不足，需要 {0} 金币"

# 成功消息
success:
  operation_completed: "操作完成"
  payment_received: "收到付款 {0} 金币"
  item_given: "已给予 {0} 个 {1}"

# GUI 相关
gui:
  button:
    confirm: "确认"
    cancel: "取消"
    next: "下一页"
    previous: "上一页"
    close: "关闭"
  title:
    main_menu: "主菜单"
    settings: "设置"
    player_info: "玩家信息"
```

#### 英文语言文件 (lang/en_US.yml)
```yaml
# Welcome messages
welcome:
  message: "Welcome {0} to the server!"
  first_time: "This is your first time joining the server"
  returning: "Welcome back, {0}! You were offline for {1}"

# Player related
player:
  level_info: "Player {0} current level: {1}"
  not_found: "Player {0} not found"
  offline: "Player {0} is currently offline"
  balance: "Your balance: {0} coins"

# Plugin messages
plugin:
  enabled: "Plugin enabled"
  disabled: "Plugin disabled"
  config:
    reloaded: "Configuration reloaded successfully"
    reloading: "Reloading configuration..."
    reload_failed: "Configuration reload failed"

# Error messages
error:
  no_permission: "You don't have permission to perform this action"
  invalid_argument: "Invalid argument: {0}"
  command_failed: "Command execution failed: {0}"
  insufficient_funds: "Insufficient funds, need {0} coins"

# Success messages
success:
  operation_completed: "Operation completed"
  payment_received: "Payment received: {0} coins"
  item_given: "Given {0} {1}"

# GUI related
gui:
  button:
    confirm: "Confirm"
    cancel: "Cancel"
    next: "Next Page"
    previous: "Previous Page"
    close: "Close"
  title:
    main_menu: "Main Menu"
    settings: "Settings"
    player_info: "Player Information"
```

## 💬 使用国际化消息

### 在插件中使用

```kotlin
class MyPlugin : BasePlugin() {
    
    override fun onPluginEnable() {
        // ✅ 语言设置前使用英文日志
        logger.info("MyPlugin enabling...")
        
        // 注册不可重载功能
        registerCommands()
        registerEventListeners()
        
        // 调用重载方法（会设置语言管理器）
        reloadPlugin()
        
        // ✅ 语言设置后可以使用 i18n 模板
        logger.info("<%plugin.enabled%>")
    }
    
    private fun sendWelcomeMessage(player: Player) {
        // 基础国际化消息
        messager.printf(player, "<%welcome.message%>", player.name)
        
        // 带参数的国际化消息
        val level = getPlayerLevel(player)
        messager.printf(player, "<%player.level_info%>", player.name, level)
        
        // 检查首次加入
        if (isFirstTimePlayer(player)) {
            messager.printf(player, "<%welcome.first_time%>")
        }
    }
    
    private fun sendErrorMessage(player: Player, error: String) {
        messager.printf(player, "<%error.command_failed%>", error)
    }
    
    private fun sendSuccessMessage(player: Player, amount: Double) {
        messager.printf(player, "<%success.payment_received%>", amount)
    }
}
```

### 在 BaseModule 中使用

```kotlin
class PlayerModule(moduleName: String, val plugin: MyPlugin) : BaseModule(moduleName, plugin) {
    
    override fun onInit() {
        // 模块初始化消息
        logger.info("<%plugin.module.initializing%>", moduleName)
        
        // 事件中使用国际化
        subscribeEvent<PlayerJoinEvent> { event ->
            val player = event.player
            
            // 发送欢迎消息
            messager.printf(player, "<%welcome.message%>", player.name)
            
            // 显示玩家信息
            val balance = getPlayerBalance(player)
            messager.printf(player, "<%player.balance%>", balance)
        }
        
        subscribeEvent<PlayerQuitEvent> { event ->
            val player = event.player
            val onlineTime = getOnlineTime(player)
            
            // 记录玩家离线
            logger.info("<%player.offline%>", player.name)
        }
    }
    
    override fun onReload() {
        // 模块重载消息
        logger.info("<%plugin.module.reloading%>", moduleName)
        
        // 重载完成
        logger.info("<%plugin.module.reloaded%>", moduleName)
    }
    
    private fun handlePlayerCommand(player: Player, command: String) {
        try {
            executePlayerCommand(player, command)
            messager.printf(player, "<%success.operation_completed%>")
        } catch (e: Exception) {
            messager.printf(player, "<%error.command_failed%>", e.message)
            logger.error("<%error.command_failed%>", e.message, e)
        }
    }
}
```

## 🔧 高级功能

### 动态语言切换

```kotlin
class MyPlugin : BasePlugin() {
    
    fun switchLanguage(newMajorLanguage: Locale) {
        try {
            logger.info("切换语言到: ${newMajorLanguage.displayName}")
            
            // 重新设置语言管理器
            setupLanguageManager(
                languageFiles = mapOf(
                    Locale.SIMPLIFIED_CHINESE to "lang/zh_CN.yml",
                    Locale.US to "lang/en_US.yml",
                    Locale.JAPAN to "lang/ja_JP.yml"
                ),
                majorLanguage = newMajorLanguage,
                defaultLanguage = Locale.US
            )
            
            // 通知所有在线玩家
            server.onlinePlayers.forEach { player ->
                messager.printf(player, "<%plugin.language_changed%>", newMajorLanguage.displayName)
            }
            
            logger.info("<%plugin.language_changed%>", newMajorLanguage.displayName)
            
        } catch (e: Exception) {
            logger.error("语言切换失败", e)
        }
    }
}
```

### 条件性消息

```kotlin
class MyPlugin : BasePlugin() {
    
    private fun sendConditionalMessage(player: Player) {
        val playerLevel = getPlayerLevel(player)
        
        when {
            playerLevel >= 100 -> {
                messager.printf(player, "<%player.level.master%>", playerLevel)
            }
            playerLevel >= 50 -> {
                messager.printf(player, "<%player.level.expert%>", playerLevel)
            }
            playerLevel >= 10 -> {
                messager.printf(player, "<%player.level.intermediate%>", playerLevel)
            }
            else -> {
                messager.printf(player, "<%player.level.beginner%>", playerLevel)
            }
        }
    }
    
    private fun sendTimeBasedMessage(player: Player) {
        val hour = LocalTime.now().hour
        
        val timeKey = when (hour) {
            in 6..11 -> "time.morning"
            in 12..17 -> "time.afternoon"
            in 18..22 -> "time.evening"
            else -> "time.night"
        }
        
        messager.printf(player, "<%$timeKey%>", player.name)
    }
}
```

### 复杂参数处理

```kotlin
class MyPlugin : BasePlugin() {
    
    private fun sendComplexMessage(player: Player) {
        val stats = getPlayerStats(player)
        
        // 多参数消息
        messager.printf(
            player,
            "<%player.stats.detailed%>",
            player.name,           // {0}
            stats.level,           // {1}
            stats.experience,      // {2}
            stats.playtime,        // {3}
            stats.achievements     // {4}
        )
        
        // 格式化数字
        val balance = getPlayerBalance(player)
        messager.printf(
            player,
            "<%player.balance.formatted%>",
            String.format("%.2f", balance)
        )
        
        // 格式化时间
        val onlineTime = getOnlineTime(player)
        val formattedTime = formatDuration(onlineTime)
        messager.printf(
            player,
            "<%player.online_time%>",
            formattedTime
        )
    }
    
    private fun formatDuration(duration: Duration): String {
        val hours = duration.toHours()
        val minutes = duration.toMinutes() % 60
        return "${hours}小时${minutes}分钟"
    }
}
```

## 🛡️ 生命周期最佳实践

### 正确的初始化顺序

```kotlin
class MyPlugin : BasePlugin() {
    
    override fun onPluginEnable() {
        // ✅ 第一阶段：基础初始化（使用英文日志）
        logger.info("MyPlugin enabling...")
        
        // 检查依赖
        if (!checkDependencies()) {
            logger.error("Dependency check failed!")
            server.pluginManager.disablePlugin(this)
            return
        }
        
        // 注册不可重载功能
        registerCommands()
        registerEventListeners()
        
        // ✅ 第二阶段：调用重载方法（设置语言管理器）
        reloadPlugin()
        
        // ✅ 第三阶段：语言设置后可以使用 i18n 模板
        logger.info("<%plugin.enabled%>")
    }
    
    override fun reloadPlugin() {
        try {
            // ✅ 重载阶段：设置语言管理器
            logger.info("<%plugin.config.reloading%>")
            
            // 1. 清理配置缓存
            configManager.clearCache()
            
            // 2. 重新设置语言管理器
            setupLanguageManager(
                languageFiles = mapOf(
                    Locale.SIMPLIFIED_CHINESE to "lang/zh_CN.yml",
                    Locale.US to "lang/en_US.yml"
                ),
                majorLanguage = Locale.SIMPLIFIED_CHINESE,
                defaultLanguage = Locale.US
            )
            
            // 3. 重载子模块
            super.reloadPlugin()
            
            logger.info("<%plugin.config.reloaded%>")
            
        } catch (e: Exception) {
            logger.error("<%plugin.config.reload_failed%>", e)
            throw e
        }
    }
}
```

### 错误处理

```kotlin
class MyPlugin : BasePlugin() {
    
    override fun reloadPlugin() {
        try {
            setupLanguageManager(
                languageFiles = mapOf(
                    Locale.SIMPLIFIED_CHINESE to "lang/zh_CN.yml",
                    Locale.US to "lang/en_US.yml"
                ),
                majorLanguage = Locale.SIMPLIFIED_CHINESE,
                defaultLanguage = Locale.US
            )
        } catch (e: Exception) {
            logger.error("语言管理器设置失败，使用默认语言", e)
            
            // 回退到默认语言
            setupLanguageManager(
                languageFiles = mapOf(
                    Locale.US to "lang/en_US.yml"
                ),
                majorLanguage = Locale.US,
                defaultLanguage = Locale.US
            )
        }
    }
}
```

## 🎯 最佳实践

### 1. 语言文件组织

```yaml
# ✅ 推荐：按功能分组
welcome:
  message: "欢迎 {0}！"
  first_time: "首次加入"

player:
  level_info: "等级：{0}"
  balance: "余额：{0}"

error:
  no_permission: "无权限"
  invalid_argument: "参数错误：{0}"
```

### 2. 模板命名规范

```kotlin
// ✅ 推荐：使用清晰的模板名称
messager.printf(player, "<%welcome.message%>", player.name)
messager.printf(player, "<%error.no_permission%>")
messager.printf(player, "<%success.operation_completed%>")

// ❌ 避免：模糊的模板名称
messager.printf(player, "<%msg1%>", player.name)
messager.printf(player, "<%err%>")
```

### 3. 参数使用

```kotlin
// ✅ 推荐：明确的参数顺序和含义
messager.printf(player, "<%player.stats%>", name, level, experience)

// 在语言文件中注释参数含义
# player.stats: "玩家 {0} 等级 {1} 经验 {2}"
# {0} = 玩家名称, {1} = 等级, {2} = 经验值
```

### 4. 生命周期管理

```kotlin
// ✅ 正确的生命周期顺序
override fun onPluginEnable() {
    logger.info("Plugin enabling...")  // 英文日志
    reloadPlugin()                     // 设置语言管理器
    logger.info("<%plugin.enabled%>") // i18n 模板
}
```

---

**相关文档：** [💬 消息系统](messaging.md) | [⚙️ 配置管理](configuration.md) | [🔄 生命周期管理](lifecycle.md)
